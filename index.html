<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIDI Sequence Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
html, body {
    height: 100%;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Arial', sans-serif; /* Use a web-safe font */
}

#section1,
#content {
    width: 100%; /* Full width */
    display: flex;
    flex-direction: column;
    align-items: center;
}

midi-player,
midi-visualizer {
    width: 800px;  /* Set a fixed width */
    height: 180px; /* Set a fixed height */
    margin: 20px auto; /* Center the element with automatic horizontal margins */
}

/* Style for the text where tokens are displayed */
#text {
    font-size: 1.2em;
    color: #000;
    margin: 20px 0; /* Spacing above and below */
}

/* Style for inputs and buttons */
input[type="number" ],
button {
    font-size: 1.2em;
    margin: 10px;
    padding: 10px 20px; /* Larger clickable area */
}

h1, h2 {
    font-size: 2em;
    color: #333;
}


/* Add a class for the tokens for easier styling */
.token {
    font-size: 1em; /* Larger than the rest of the text */
    margin: 0 5px; /* Space out tokens */
}
         h1, h2 {
            color: #333;
            font-size: 3em;
        }
                /* Custom player style */


      
       

            </style>


<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@magenta/music@^1.0.0"></script>

<script src="https://cdn.jsdelivr.net/combine/npm/tone@14.7.58,npm/@magenta/music@1.23.1/es6/core.js,npm/focus-visible@5,npm/html-midi-player@1.5.0"></script>



</head>

<body>

    <div>
        <input type="file" id="midiFileInput" accept=".mid,.midi" />
    </div>
    

<section id="section1">
    <h1>MIDI sequence generator</h1>
    <!-- <midi-player
      id = "player"
      src=""
      sound-font visualizer="#section3 midi-visualizer">
    </midi-player>
    <midi-visualizer
    id ="v_roll"
      src="https://cdn.jsdelivr.net/gh/cifkao/html-midi-player@2b12128/jazz.mid">
    </midi-visualizer> -->


    <midi-player
    src="https://cdn.jsdelivr.net/gh/cifkao/html-midi-player@2b12128/twinkle_twinkle.mid"
    sound-font visualizer="#section1 midi-visualizer">
  </midi-player>

<midi-visualizer
id = "player"
  type="piano-roll"
  src="https://cdn.jsdelivr.net/gh/cifkao/html-midi-player@2b12128/twinkle_twinkle.mid">
</midi-visualizer>


 
  


</section>




<div>
    <input type="number" id="maxValueInput" placeholder="Enter Sequence Length" step="10" />

    <button id="generateButton">Generate MIDI Sequence</button>
    <button id="clearContextButton">Clear Context</button>
    

</div>

<div id="content">
    <span id="text"></span>
    <span id="carret" class="text-black animate-ping">|</span>
  </div>





<script type="module">

import midiWriterJs from "https://cdn.skypack.dev/midi-writer-js@2.1.4";

import tokenizer_encode from './tokenizer_js_encode.json' assert { type: 'json' };
import tokenizer_decode from './tokenizer_js_decode.json' assert { type: 'json' };



let block_size = 5;
let globalContext = ['Position_0'];
let full_remi = [];


// let seq = "PIECE_START STYLE=JSFAKES GENRE=JSFAKES TRACK_START INST=48 BAR_START NOTE_ON=67 TIME_DELTA=4 NOTE_OFF=67 NOTE_ON=70 TIME_DELTA=4 NOTE_OFF=70 NOTE_ON=72 TIME_DELTA=4 NOTE_OFF=72 NOTE_ON=69 TIME_DELTA=4 NOTE_OFF=69 BAR_END BAR_START NOTE_ON=70 TIME_DELTA=4 NOTE_OFF=70 NOTE_ON=65 TIME_DELTA=2 NOTE_OFF=65 NOTE_ON=67 TIME_DELTA=2 NOTE_OFF=67 NOTE_ON=65 TIME_DELTA=8 NOTE_OFF=65 BAR_END BAR_START NOTE_ON=66 TIME_DELTA=4 NOTE_OFF=66 NOTE_ON=67 TIME_DELTA=4 NOTE_OFF=67 NOTE_ON=67 TIME_DELTA=4 NOTE_OFF=67 NOTE_ON=65 TIME_DELTA=4 NOTE_OFF=65 BAR_END BAR_START NOTE_ON=65 TIME_DELTA=8 NOTE_OFF=65 NOTE_ON=64 TIME_DELTA=8 NOTE_OFF=64 BAR_END TRACK_END TRACK_START INST=0 BAR_START NOTE_ON=75 TIME_DELTA=4 NOTE_OFF=75 NOTE_ON=77 TIME_DELTA=4 NOTE_OFF=77 NOTE_ON=77 TIME_DELTA=4 NOTE_OFF=77 NOTE_ON=75 TIME_DELTA=4 NOTE_OFF=75 BAR_END BAR_START NOTE_ON=74 TIME_DELTA=2 NOTE_OFF=74 NOTE_ON=72 TIME_DELTA=2 NOTE_OFF=72 NOTE_ON=70 TIME_DELTA=4 NOTE_OFF=70 NOTE_ON=69 TIME_DELTA=8 NOTE_OFF=69 BAR_END BAR_START NOTE_ON=69 TIME_DELTA=4 NOTE_OFF=69 NOTE_ON=70 TIME_DELTA=4 NOTE_OFF=70 NOTE_ON=72 TIME_DELTA=4 NOTE_OFF=72 NOTE_ON=69 TIME_DELTA=4 NOTE_OFF=69 BAR_END BAR_START NOTE_ON=70 TIME_DELTA=4 NOTE_OFF=70 NOTE_ON=68 TIME_DELTA=4 NOTE_OFF=68 NOTE_ON=67 TIME_DELTA=8 NOTE_OFF=67 BAR_END TRACK_END TRACK_START INST=32 BAR_START NOTE_ON=60 TIME_DELTA=4 NOTE_OFF=60 NOTE_ON=58 TIME_DELTA=4 NOTE_OFF=58 NOTE_ON=57 TIME_DELTA=4 NOTE_OFF=57 NOTE_ON=53 TIME_DELTA=4 NOTE_OFF=53 BAR_END BAR_START NOTE_ON=58 TIME_DELTA=4 NOTE_OFF=58 NOTE_ON=50 TIME_DELTA=2 NOTE_OFF=50 NOTE_ON=51 TIME_DELTA=2 NOTE_OFF=51 NOTE_ON=53 TIME_DELTA=8 NOTE_OFF=53 BAR_END BAR_START NOTE_ON=50 TIME_DELTA=4 NOTE_OFF=50 NOTE_ON=55 TIME_DELTA=2 NOTE_OFF=55 NOTE_ON=53 TIME_DELTA=2 NOTE_OFF=53 NOTE_ON=52 TIME_DELTA=4 NOTE_OFF=52 NOTE_ON=53 TIME_DELTA=2 NOTE_OFF=53 NOTE_ON=41 TIME_DELTA=2 NOTE_OFF=41 BAR_END BAR_START NOTE_ON=46 TIME_DELTA=4 NOTE_OFF=46 NOTE_ON=47 TIME_DELTA=4 NOTE_OFF=47 NOTE_ON=48 TIME_DELTA=8 NOTE_OFF=48 BAR_END TRACK_END TRACK_START INST=24 BAR_START NOTE_ON=60 TIME_DELTA=4 NOTE_OFF=60 NOTE_ON=62 TIME_DELTA=4 NOTE_OFF=62 NOTE_ON=60 TIME_DELTA=4 NOTE_OFF=60 NOTE_ON=65 TIME_DELTA=4 NOTE_OFF=65 BAR_END BAR_START NOTE_ON=65 TIME_DELTA=2 NOTE_OFF=65 NOTE_ON=63 TIME_DELTA=2 NOTE_OFF=63 NOTE_ON=62 TIME_DELTA=4 NOTE_OFF=62 NOTE_ON=60 TIME_DELTA=8 NOTE_OFF=60 BAR_END BAR_START NOTE_ON=62 TIME_DELTA=4 NOTE_OFF=62 NOTE_ON=62 TIME_DELTA=4 NOTE_OFF=62 NOTE_ON=60 TIME_DELTA=4 NOTE_OFF=60 NOTE_ON=60 TIME_DELTA=4 NOTE_OFF=60 BAR_END BAR_START NOTE_ON=62 TIME_DELTA=2 NOTE_OFF=62 NOTE_ON=63 TIME_DELTA=2 NOTE_OFF=63 NOTE_ON=62 TIME_DELTA=4 NOTE_OFF=62 NOTE_ON=60 TIME_DELTA=8 NOTE_OFF=60 BAR_END TRACK_END PIECE_END";
// let token_array = seq.split(" ");
// console.log(token_array);

// const midi = tokenSequenceToNoteSequence(token_array, 120.0, true, true, null, false);


function remiTokensToMidi(tokens, ticksPerSample) {
    let track = new midiWriterJs.Track();

    let currentTick = 0;
    let tickAtCurrentBar = 0;
    let currentProgram = 0;
    let currentDuration = 'T120';
    let currentVelocity = 50;

    tokens.forEach(tokenGroup => {
        tokenGroup.forEach(token => {
            let [tokenType, tokenValue] = token.split('_');

            switch (tokenType) {
                case 'Pitch':
                    if (tokenValue !== null && !isNaN(tokenValue)) {
                        const note = new midiWriterJs.NoteEvent({
                            pitch: [tokenValue],
                            duration: currentDuration,
                            velocity: currentVelocity
                        });
                        track.addEvent(note);
                    }
                    break;
                case 'Velocity':
                    if (!isNaN(parseInt(tokenValue))) {
                        currentVelocity = parseInt(tokenValue);
                    }
                    break;
                case 'Duration':
                    if (tokenValue) {
                        let [beat, pos, res] = tokenValue.split('.').map(Number);
                        let durationInTicks = (beat * res + pos) * ticksPerSample / res;
                        currentDuration = 'T' + durationInTicks;
                    }
                    break;
                case 'Position':
                    if (!isNaN(parseInt(tokenValue))) {
                        currentTick = (tickAtCurrentBar) + parseInt(tokenValue) * ticksPerSample;
                    }
                    break;
                case 'Program':
                    let programNumber = parseInt(tokenValue);
                    if (!isNaN(programNumber) && programNumber >= 0 && programNumber <= 127) {
                        currentProgram = programNumber;
                        track.addEvent(new midiWriterJs.ProgramChangeEvent({instrument: currentProgram}));
                    }
                    break;
                
            }
        });
    });

    // Convert the track to a MIDI file
    let write = new midiWriterJs.Writer([track]);
    return write.buildFile();
}



const text = document.getElementById("text")
      const display = (token) => {
        globalContext.push(token);
        text.innerHTML = globalContext
    
       
        
      }
      const clearContext = () => {
        globalContext = ['Position_0'];  // Reset the context
        text.innerHTML = '';  // Clear the display
    }








    function decode(tokenIds) {
    return tokenIds.map(id => tokenizer_decode[id]).join(' ');
}

function encode(tokens) {
    
    return tokens.map(text => 
        tokenizer_encode[text] !== undefined ? tokenizer_encode[text] : 3 // 3 for unknown tokens
    );
}

const softmax = (logits, temperature) => {
        const exps = logits.map((value) => Math.exp(value / temperature))
        const sumExps = exps.reduce((acc, val) => acc + val)
        return exps.map((exp) => exp / sumExps)
      }

const multinomial = (probas, topK) => {
const choices = probas.map((w, i) => ({ w, i })).sort((a, b) => b.w - a.w)
const weights = choices.slice(0, topK).map((c) => c.w)
const total = weights.reduce((a, c) => a += c)
const num = Math.random()
let sum = 0
for (let weight of weights) {
    sum += weight / total
    if (num < sum) return choices.filter(({ w, i }) => w === weight)[0].i
}
return choices.filter(({ w, i }) => w === weights[-1])[0].i
}

const generate = async (session, ctx, ctxSize, temperature, topK) => {

        const idxs = encode(ctx).slice(-ctxSize)
        const input = new ort.Tensor('int64', idxs, [1, idxs.length])
        const result = await session.run({ 'input': input })
        const output = [...result.output.data]
        const logits = output.slice(-output.length / idxs.length)
        const idx = multinomial(softmax(logits, temperature), topK)
        ctx = decode([...idxs.slice(-ctxSize + 1), idx])
        
        
        display(decode([idx]))
}
    
      


const write = async () => {
    const maxValue = parseInt(document.getElementById('maxValueInput').value);
    if (maxValue < 1) return;
    const session = await ort.InferenceSession.create('models/musicgen.onnx');
    const ctxSize = block_size;
    const temperature = 1.0;
    const topK = 100;
    
    while (true) {
        await generate(session, globalContext, ctxSize, temperature, topK);
        const currentValue = globalContext.length;
        if (currentValue >= maxValue) break;
    }
};



function updateMidiSource() {
    var input = document.getElementById('midiFileInput');
    var file = input.files[0];
    if (file) {
        var reader = new FileReader();

        reader.onload = function(e) {
            var midiPlayer = document.querySelector('midi-player');
            var midiVisualizer = document.querySelector('midi-visualizer');

            midiPlayer.src = e.target.result;
            midiVisualizer.src = e.target.result;

            midiPlayer.stop();
            midiPlayer.start();
        };

        reader.readAsDataURL(file);
    }
}


const displayTokenByToken = (tokens) => {
    tokenDisplay.innerHTML = ''; // Clear current display
    let index = 0;

    const intervalId = setInterval(() => {
        if(index < tokens.length){
            let span = document.createElement('span');
            span.classList.add('token');
            span.textContent = tokens[index] + ' ';
            tokenDisplay.appendChild(span);
            index++;
        } else {
            clearInterval(intervalId);
        }
    }, 50); // Adjust the interval time as needed
}


document.getElementById('clearContextButton').addEventListener('click', clearContext);
document.getElementById('midiFileInput').addEventListener('change', updateMidiSource);
const tokenDisplay = document.getElementById("text");
document.getElementById('generateButton').addEventListener('click', async () => {
    // Generate the MIDI file from tokens
    await write();
    let ticksPerSample = 120;

    displayTokenByToken(globalContext);

   let midiFile = remiTokensToMidi([globalContext], ticksPerSample);

    // Convert the MIDI file to a Blob
    let midiBlob = new Blob([midiFile], {type: 'audio/midi'});

    // Create a data URL from the Blob
    let midiURL = URL.createObjectURL(midiBlob);

    // Load and set the generated MIDI file to the MIDI player and visualizer
    document.querySelector('midi-player').src = midiURL;
    document.querySelector('midi-visualizer').src = midiURL;

    // Start playing the MIDI file
    document.querySelector('midi-player').stop();
    document.querySelector('midi-player').start();
});



</script>




</body>


</html>